import { v4 } from "hookmate/abi";
import { decodeFunctionData, type Hex } from "viem";
import { unichain } from "viem/chains";

import { UniswapSDK } from "@/core/sdk";
import { UNICHAIN_POOL_KEY } from "@/test/fixtures/unichain";
import { TEST_RECIPIENT } from "@/test/integration/constants";
import { createPinnedUnichainClient } from "@/test/integration/pinnedClient";

describe("buildAddLiquidityCallData (unichain rpc)", () => {
  it("builds add liquidity calldata", async () => {
    const client = createPinnedUnichainClient();
    const sdk = UniswapSDK.create(client, unichain.id);
    const pool = await sdk.getPool(UNICHAIN_POOL_KEY);

    const { calldata, value } = await sdk.buildAddLiquidityCallData({
      pool,
      amount0: "100000000000000",
      recipient: TEST_RECIPIENT,
      slippageTolerance: 100,
    });

    const decoded = decodeFunctionData({
      abi: v4.PositionManagerArtifact.abi,
      data: calldata as Hex,
    });

    const [, deadline] = decoded.args as [Hex, bigint];

    expect(decoded.functionName).toBe("modifyLiquidities");
    expect(deadline).toBe(1770378227n);
    expect(calldata).toMatchInlineSnapshot(
      `"0xdd46508f0000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000006985d3f30000000000000000000000000000000000000000000000000000000000000380000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000003020d140000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000300000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000220000000000000000000000000000000000000000000000000000000000000028000000000000000000000000000000000000000000000000000000000000001a00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000078d782b760474a361dda0af3839290b0ef57ad600000000000000000000000000000000000000000000000000000000000001f4000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000000fffffffffffffffffffffffffffffffffffffffffffffffffffffffffff2761a00000000000000000000000000000000000000000000000000000000000d89e60000000000000000000000000000000000000000000000000000000105ba444a00000000000000000000000000000000000000000000000000005b685c31f8be000000000000000000000000000000000000000000000000000000000002f4f000000000000000000000000022222222222222222222222222222222222222220000000000000000000000000000000000000000000000000000000000000180000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000078d782b760474a361dda0af3839290b0ef57ad6000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001"`,
    );
    expect(value).toBe("0x5b685c31f8be");
  });
});
