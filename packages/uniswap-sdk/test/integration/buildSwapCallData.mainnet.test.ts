import { utility } from "hookmate/abi";
import { decodeFunctionData, type Hex } from "viem";
import { unichain } from "viem/chains";

import { UniswapSDK } from "@/core/sdk";
import { UNICHAIN_POOL_KEY, UNICHAIN_WETH_IS_CURRENCY0, UNICHAIN_WETH_POOL_KEY } from "@/test/fixtures/unichain";
import { TEST_RECIPIENT } from "@/test/integration/constants";
import { createPinnedUnichainClient } from "@/test/integration/pinnedClient";

describe("buildSwapCallData (unichain rpc)", () => {
  it("builds universal router calldata", async () => {
    const client = createPinnedUnichainClient();
    const sdk = UniswapSDK.create(client, unichain.id);
    const block = await client.getBlock();
    const expectedDeadline = block.timestamp + BigInt(sdk.defaultDeadline);
    const pool = await sdk.getPool(UNICHAIN_POOL_KEY);

    const calldata = await sdk.buildSwapCallData({
      amountIn: 1_000_000n,
      amountOutMinimum: 0n,
      pool,
      zeroForOne: false,
      recipient: TEST_RECIPIENT,
    });

    const decoded = decodeFunctionData({
      abi: utility.UniversalRouterArtifact.abi,
      data: calldata,
    });

    expect(decoded.functionName).toBe("execute");

    const [commands, , deadline] = decoded.args as [Hex, Hex[], bigint];
    // V4_SWAP command byte from universal-router-sdk CommandType.V4_SWAP.
    expect(commands).toBe("0x10");
    expect(deadline).toBe(expectedDeadline);
    expect(calldata).toMatchInlineSnapshot(
      `"0x3593564c000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000006985d3f300000000000000000000000000000000000000000000000000000000000000011000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000380000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000003060b0e00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000001e00000000000000000000000000000000000000000000000000000000000000260000000000000000000000000000000000000000000000000000000000000016000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000078d782b760474a361dda0af3839290b0ef57ad600000000000000000000000000000000000000000000000000000000000001f4000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000f42400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000012000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000060000000000000000000000000078d782b760474a361dda0af3839290b0ef57ad6000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000000000000000000000000000000022222222222222222222222222222222222222220000000000000000000000000000000000000000000000000000000000000000"`,
    );
  });

  it("adds WRAP_ETH command when useNativeETH is true and input is WETH", async () => {
    const client = createPinnedUnichainClient();
    const sdk = UniswapSDK.create(client, unichain.id);
    const block = await client.getBlock();
    const expectedDeadline = block.timestamp + BigInt(sdk.defaultDeadline);
    const pool = await sdk.getPool(UNICHAIN_WETH_POOL_KEY);

    const calldata = await sdk.buildSwapCallData({
      amountIn: 1_000_000n,
      amountOutMinimum: 0n,
      pool,
      zeroForOne: UNICHAIN_WETH_IS_CURRENCY0,
      recipient: TEST_RECIPIENT,
      useNativeETH: true,
    });

    const decoded = decodeFunctionData({
      abi: utility.UniversalRouterArtifact.abi,
      data: calldata,
    });

    expect(decoded.functionName).toBe("execute");

    const [commands, inputs, deadline] = decoded.args as [Hex, Hex[], bigint];
    // WRAP_ETH (0x0b) + V4_SWAP (0x10)
    expect(commands).toBe("0x0b10");
    expect(inputs).toHaveLength(2);
    expect(deadline).toBe(expectedDeadline);
    expect(calldata).toMatchInlineSnapshot(
      `"0x3593564c000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000006985d3f300000000000000000000000000000000000000000000000000000000000000020b100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000f42400000000000000000000000000000000000000000000000000000000000000380000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000003060b0e00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000001e0000000000000000000000000000000000000000000000000000000000000026000000000000000000000000000000000000000000000000000000000000001600000000000000000000000000000000000000000000000000000000000000020000000000000000000000000078d782b760474a361dda0af3839290b0ef57ad600000000000000000000000042000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000bb8000000000000000000000000000000000000000000000000000000000000003c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000f424000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000120000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000004200000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000060000000000000000000000000078d782b760474a361dda0af3839290b0ef57ad600000000000000000000000022222222222222222222222222222222222222220000000000000000000000000000000000000000000000000000000000000000"`,
    );
  });

  it("adds UNWRAP_WETH command when useNativeETH is true and output is WETH", async () => {
    const client = createPinnedUnichainClient();
    const sdk = UniswapSDK.create(client, unichain.id);
    const block = await client.getBlock();
    const expectedDeadline = block.timestamp + BigInt(sdk.defaultDeadline);
    const pool = await sdk.getPool(UNICHAIN_WETH_POOL_KEY);

    const calldata = await sdk.buildSwapCallData({
      amountIn: 1_000_000n,
      amountOutMinimum: 0n,
      pool,
      zeroForOne: !UNICHAIN_WETH_IS_CURRENCY0,
      recipient: TEST_RECIPIENT,
      useNativeETH: true,
    });

    const decoded = decodeFunctionData({
      abi: utility.UniversalRouterArtifact.abi,
      data: calldata,
    });

    expect(decoded.functionName).toBe("execute");

    const [commands, inputs, deadline] = decoded.args as [Hex, Hex[], bigint];
    // V4_SWAP (0x10) + UNWRAP_WETH (0x0c)
    expect(commands).toBe("0x100c");
    expect(inputs).toHaveLength(2);
    expect(deadline).toBe(expectedDeadline);
    expect(calldata).toMatchInlineSnapshot(
      `"0x3593564c000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000006985d3f30000000000000000000000000000000000000000000000000000000000000002100c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000003e00000000000000000000000000000000000000000000000000000000000000380000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000003060b0e00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000001e0000000000000000000000000000000000000000000000000000000000000026000000000000000000000000000000000000000000000000000000000000001600000000000000000000000000000000000000000000000000000000000000020000000000000000000000000078d782b760474a361dda0af3839290b0ef57ad600000000000000000000000042000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000bb8000000000000000000000000000000000000000000000000000000000000003c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000f42400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000012000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000060000000000000000000000000078d782b760474a361dda0af3839290b0ef57ad6000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000060000000000000000000000000420000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000022222222222222222222222222222222222222220000000000000000000000000000000000000000000000000000000000000000"`,
    );
  });
});
