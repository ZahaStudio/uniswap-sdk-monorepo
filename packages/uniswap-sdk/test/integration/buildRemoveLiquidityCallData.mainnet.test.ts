import { v4 } from "hookmate/abi";
import { decodeFunctionData, type Hex } from "viem";
import { unichain } from "viem/chains";

import { UniswapSDK } from "@/core/sdk";
import { ACTIVE_POSITION_TOKEN_ID } from "@/test/integration/constants";
import { createPinnedUnichainClient } from "@/test/integration/pinnedClient";

describe("buildRemoveLiquidityCallData (unichain rpc)", () => {
  it("builds remove liquidity calldata for an active position", async () => {
    const client = createPinnedUnichainClient();
    const sdk = UniswapSDK.create(client, unichain.id);

    const { calldata, value } = await sdk.buildRemoveLiquidityCallData({
      tokenId: ACTIVE_POSITION_TOKEN_ID,
      liquidityPercentage: 100,
      slippageTolerance: 100,
    });

    const decoded = decodeFunctionData({
      abi: v4.PositionManagerArtifact.abi,
      data: calldata as Hex,
    });

    const [, deadline] = decoded.args as [Hex, bigint];

    expect(decoded.functionName).toBe("modifyLiquidities");
    expect(deadline).toBe(1770378227n);
    expect(calldata).toMatchInlineSnapshot(
      `"0xdd46508f0000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000006985d3f30000000000000000000000000000000000000000000000000000000000000240000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000002011100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000012000000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000259a4b000000000000000000000000000000000000000000000000000000009af9a13f0000000000000000000000000000000000000000000000000000000000ad8c3d000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000555e30da8f98308edb960aa94c0db47230d2b9c000000000000000000000000078d782b760474a361dda0af3839290b0ef57ad60000000000000000000000000000000000000000000000000000000000000001"`,
    );
    expect(value).toBe("0x00");
  });
});
